{% extends "_base.html" %}

{% load static %}
{% load humanize %}
{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.css">
<link rel="stylesheet" href="//cdn.datatables.net/2.2.2/css/dataTables.dataTables.min.css">
<link rel="stylesheet" href="//cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">
<link rel="stylesheet" href="//cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">
<link rel="stylesheet" href="{% static 'css/datatables-buttons.css' %}">
<style>
  /* Estilos personalizados para DataTables */
  .dataTables_wrapper .dataTables_paginate .paginate_button {
    padding: 8px 12px !important;
    margin: 0 2px !important;
    border-radius: 6px !important;
    border: 1px solid #d1d5db !important;
    background: #f3f4f6 !important;
    color: #374151 !important;
    transition: all 0.2s ease !important;
    display: inline-block !important;
    text-decoration: none !important;
  }
  
  .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
    background: #e5e7eb !important;
    border-color: #9ca3af !important;
    color: #374151 !important;
    text-decoration: none !important;
  }
  
  .dataTables_wrapper .dataTables_paginate .paginate_button.current {
    background: #3b82f6 !important;
    border-color: #3b82f6 !important;
    color: white !important;
    font-weight: 600 !important;
  }
  
  .dataTables_wrapper .dataTables_paginate .paginate_button.current:hover {
    background: #2563eb !important;
    border-color: #2563eb !important;
    color: white !important;
  }
  
  .dataTables_wrapper .dataTables_paginate .paginate_button.disabled {
    background: #f9fafb !important;
    border-color: #e5e7eb !important;
    color: #9ca3af !important;
    cursor: not-allowed !important;
  }
  
  .dataTables_wrapper .dataTables_paginate .paginate_button.disabled:hover {
    background: #f9fafb !important;
    border-color: #e5e7eb !important;
    color: #9ca3af !important;
  }
  
  .dataTables_wrapper .dataTables_paginate {
    margin: 20px 0 !important;
  }
  
  .dataTables_wrapper .dataTables_paginate .ellipsis {
    padding: 8px 4px !important;
    color: #9ca3af !important;
  }
  
  .dataTables_wrapper .dataTables_length select {
    background: white !important;
    border: 1px solid #d1d5db !important;
    border-radius: 6px !important;
    padding: 6px 12px !important;
    font-size: 14px !important;
    color: #374151 !important;
    margin: 0 8px !important;
  }
  
  .dataTables_wrapper .dataTables_length {
    font-size: 14px !important;
    color: #6b7280 !important;
    font-weight: 500 !important;
  }
  
  .dataTables_wrapper .dataTables_info {
    font-size: 14px !important;
    color: #6b7280 !important;
    font-weight: 500 !important;
  }
  
  .dataTables_wrapper .dataTables_filter input {
    border: 1px solid #d1d5db !important;
    border-radius: 6px !important;
    padding: 8px 12px !important;
    font-size: 14px !important;
    margin-left: 8px !important;
  }
  
  .dataTables_wrapper .dataTables_filter input:focus {
    outline: none !important;
    border-color: #3b82f6 !important;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
  }
</style>
{% endblock %}

{% block content %}
  <div class="container mx-auto px-4 py-6">
    <!-- Toast Notification - Mejorado con más estilos y animaciones -->
    <div id="toast-notification" class="fixed top-4 right-4 z-50 transform translate-x-full transition-all duration-300 opacity-0">
      <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-l-4 border-green-500 p-4 rounded-md shadow-xl flex items-start max-w-md">
        <div class="flex-shrink-0 text-green-600">
          <i class="fas fa-filter text-xl animate-pulse"></i>
        </div>
        <div class="ml-3 flex-1">
          <p class="text-sm font-medium text-green-800" id="toast-title">¡Filtros aplicados!</p>
          <p class="text-sm text-green-700 mt-1" id="toast-message">
            La información ha sido filtrada según los criterios seleccionados.
          </p>
        </div>
        <button type="button" class="ml-3 -mx-1.5 -my-1.5 bg-green-100 text-green-500 rounded-lg p-1.5 hover:bg-green-200 inline-flex h-8 w-8 items-center justify-center transition-colors duration-200" onclick="hideToast()">
          <i class="fas fa-times text-sm"></i>
        </button>
      </div>
    </div>
    
    <h1 class="text-3xl font-bold flex items-center mb-8 text-gray-800 border-b pb-2">
      <i class="fas fa-chart-line mr-3 text-blue-600"></i>
      <span class="bg-clip-text text-gray-800">Análisis de gastos </span>
    </h1>
    
    <!-- Warning -->
    <div id="warning-message" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6 rounded-md shadow-sm" role="alert">
      <div class="flex items-center">
        <div class="py-1"><i class="fas fa-exclamation-triangle text-yellow-500 mr-3"></i></div>
        <div>
          <p class="font-bold text-lg">Atención</p>
          <p>El filtro por defecto es diario. Por favor, seleccione el periodo deseado.</p>
        </div>
      </div>
    </div>

    <!-- Formulario de filtros -->
    <div class="bg-gradient-to-r from-gray-50 to-gray-100 text-gray-800 shadow-md rounded-lg p-5 border border-gray-200 mb-10">
      <form method="get" action="{% url 'balances' %}" class="space-y-6">
        <div class="flex flex-wrap gap-4 mb-4">
        
          <div class="flex-1 min-w-[200px] group">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 mb-2">
              <i class="fas fa-university mr-1"></i> Cuenta
            </span>

            <label for="cuenta_id" class="block font-medium mb-2 group-hover:text-blue-300 transition-colors duration-200">Seleccione la Cuenta:</label>
            <div class="relative">
              <select name="cuenta_id" id="cuenta_id" 
                class="block appearance-none w-full bg-white bg-opacity-90 border border-gray-400 hover:border-blue-500 px-4 py-2 pr-8 rounded-md shadow transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">Todas</option>
                {% for cuenta in cuentas %}
                <option value="{{ cuenta.id }}" {% if cuenta.id|stringformat:"s" == selected_cuenta_id %}selected{% endif %}>{{ cuenta.numero_cuenta }}</option>
                {% endfor %}
              </select>
              <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-600">
                <i class="fas fa-chevron-down text-xs"></i>
              </div>
            </div>
          </div>
      
          <div class="flex-1 min-w-[200px] group">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800 mb-2">
              <i class="fas fa-calendar-alt mr-1"></i> Año
            </span>
            <label for="year" class="block font-medium mb-2 group-hover:text-indigo-300 transition-colors duration-200">Seleccione el Año:</label>
            <div class="relative">
              <select name="year" id="year" 
                class="block appearance-none w-full bg-white bg-opacity-90 border border-gray-400 hover:border-indigo-500 px-4 py-2 pr-8 rounded-md shadow transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                {% for year in available_years %}
                <option value="{{ year.year }}" {% if year.year|stringformat:"s" == selected_year or not selected_year and year.year == current_year %}selected{% endif %}>{{ year.year }}</option>
                {% endfor %}
              </select>
              <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-600">
                <i class="fas fa-chevron-down text-xs"></i>
              </div>
            </div>
          </div>
      
          <div class="flex-1 min-w-[200px] group">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-pink-100 text-pink-800 mb-2">
              <i class="fas fa-calendar-alt mr-1"></i> Mes
            </span>
            <label for="month" class="block font-medium mb-2 group-hover:text-pink-300 transition-colors duration-200">Seleccione el Mes:</label>
            <div class="relative">
              <select name="month" id="month" 
                class="block appearance-none w-full bg-white bg-opacity-90 border border-gray-400 hover:border-pink-500 px-4 py-2 pr-8 rounded-md shadow transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-transparent">
                <option value="">Todos</option>
                {% for month in months %}
                <option value="{{ forloop.counter }}" {% if forloop.counter|stringformat:"s" == selected_month %}selected{% endif %}>{{ month }}</option>
                {% endfor %}
              </select>
              <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-600">
                <i class="fas fa-chevron-down text-xs"></i>
              </div>
            </div>
          </div>
      
          <div class="flex-1 min-w-[200px] group">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 mb-2">
              <i class="fas fa-clock mr-1"></i> Periodo
            </span>
            <label for="periodo" class="block font-medium mb-2 group-hover:text-red-300 transition-colors duration-200">Seleccione el Periodo:</label>
            <div class="relative">
              <select name="periodo" id="periodo" 
                class="block appearance-none w-full bg-white bg-opacity-90 border border-gray-400 hover:border-red-500 px-4 py-2 pr-8 rounded-md shadow transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent">
                <option value="diario" {% if selected_periodo == 'diario' %}selected{% endif %}>Diario</option>
                <option value="semanal" {% if selected_periodo == 'semanal' %}selected{% endif %}>Semanal</option>
                <option value="mensual" {% if selected_periodo == 'mensual' %}selected{% endif %}>Mensual</option>
              </select>
              <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-600">
                <i class="fas fa-chevron-down text-xs"></i>
              </div>
            </div>
          </div>
        </div>

        <div class="flex flex-wrap gap-4 mb-4" id="dia-container" style="display: {% if selected_periodo == 'diario' %}flex{% else %}none{% endif %};">
          <div class="flex-1 min-w-[200px] group">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-cyan-100 text-cyan-800 mb-2">
              <i class="fas fa-calendar-day mr-1"></i> Día específico
            </span>
            <label for="dia" class="block font-medium mb-2 group-hover:text-cyan-300 transition-colors duration-200">Seleccione el Día:</label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">
                <i class="fas fa-calendar"></i>
              </div>
              <input type="date" name="dia" id="dia" 
                class="block w-full pl-10 pr-3 py-2 bg-white bg-opacity-90 border border-gray-400 hover:border-cyan-500 rounded-md shadow transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent" value="{{ selected_dia }}">
            </div>
          </div>
          <div class="flex-1 min-w-[200px] group">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800 mb-2">
              <i class="fas fa-calendar-minus mr-1"></i> Desde
            </span>
            <label for="fecha_inicio" class="block font-medium mb-2 group-hover:text-emerald-300 transition-colors duration-200">Fecha Inicio:</label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">
                <i class="fas fa-calendar"></i>
              </div>
              <input type="date" name="fecha_inicio" id="fecha_inicio" 
                class="block w-full pl-10 pr-3 py-2 bg-white bg-opacity-90 border border-gray-400 hover:border-emerald-500 rounded-md shadow transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent" value="{{ selected_fecha_inicio }}">
            </div>
          </div>
          <div class="flex-1 min-w-[200px] group">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-teal-100 text-teal-800 mb-2">
              <i class="fas fa-calendar-plus mr-1"></i> Hasta
            </span>
            <label for="fecha_fin" class="block font-medium mb-2 group-hover:text-teal-300 transition-colors duration-200">Fecha Fin:</label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">
                <i class="fas fa-calendar"></i>
              </div>
              <input type="date" name="fecha_fin" id="fecha_fin" 
                class="block w-full pl-10 pr-3 py-2 bg-white bg-opacity-90 border border-gray-400 hover:border-teal-500 rounded-md shadow transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent" value="{{ selected_fecha_fin }}">
            </div>
          </div>
        </div>
        <div class="flex items-center justify-between pt-4">
          <button type="submit" 
            class="bg-gradient-to-r from-blue-600 to-blue-800 hover:from-blue-700 hover:to-blue-900 text-white font-bold py-3 px-6 rounded-md shadow-md hover:shadow-lg transition-all duration-300 flex items-center group">
            <i class="fas fa-filter mr-2 group-hover:animate-pulse"></i>Aplicar
          </button>
          <a href="{% url 'balances' %}" 
             class="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white font-bold py-3 px-6 rounded-md shadow-md hover:shadow-lg transition-all duration-300 flex items-center group">
            <i class="fas fa-undo mr-2 group-hover:animate-spin"></i>Restablecer
          </a>
        </div>
      </form>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
      <!-- Tarjetas de métricas superiores -->
      <div class="lg:col-span-2">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 h-full">
          <!-- Acumulado total -->
          <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg shadow-lg p-5 border border-blue-200 transform transition-transform duration-300 hover:scale-[1.02] overflow-hidden relative">
            <div class="absolute top-0 right-0 -mt-4 -mr-4 bg-blue-500 rounded-full w-20 h-20 opacity-20"></div>
            <div class="flex justify-between items-center">
              <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                <i class="fas fa-money-bill-wave text-blue-600 mr-2 text-3xl"></i>
                <span>Acumulado total</span>
              </h2>
              <span class="text-3xl font-bold text-blue-600">${{ total_gastos|floatformat:2|intcomma }}</span>
            </div>
            <div class="mt-4 h-1 w-full bg-gray-200 rounded-full overflow-hidden">
              <div class="bg-blue-500 h-1 rounded-full" style="width: 100%"></div>
            </div>
          </div>

          <!-- Promedio de gastos -->
          <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-lg shadow-lg p-5 border border-emerald-200 transform transition-transform duration-300 hover:scale-[1.02] overflow-hidden relative">
            <div class="absolute top-0 right-0 -mt-4 -mr-4 bg-emerald-500 rounded-full w-20 h-20 opacity-20"></div>
            <div class="flex justify-between items-center">
              <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                <i class="fas fa-calculator text-emerald-600 mr-2 text-3xl"></i>
                <span>Promedio</span>
              </h2>
              <span class="text-3xl font-bold text-emerald-600">${{ promedio_gastos|floatformat:2|intcomma }}</span>
            </div>
            <div class="mt-4 h-1 w-full bg-gray-200 rounded-full overflow-hidden">
              <div class="bg-emerald-500 h-1 rounded-full" style="width: {{ promedio_gastos|default:0|floatformat:0|intcomma }}%"></div>
            </div>
          </div>
          
          <!-- Transacciones -->
          <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg shadow-lg p-5 border border-purple-200 transform transition-transform duration-300 hover:scale-[1.02] overflow-hidden relative">
            <div class="absolute top-0 right-0 -mt-4 -mr-4 bg-purple-500 rounded-full w-20 h-20 opacity-20"></div>
            <div class="flex justify-between items-center">
              <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                <i class="fas fa-exchange-alt text-purple-600 mr-2 text-3xl"></i>
                <span>Transacciones</span>
              </h2>
              <span class="text-3xl font-bold text-purple-600">{{ numero_transacciones }}</span>
            </div>
            <div class="mt-4 h-1 w-full bg-gray-200 rounded-full overflow-hidden">
              <div class="bg-purple-500 h-1 rounded-full" style="width: {{ numero_transacciones|default:0|floatformat:0|intcomma }}%"></div>
            </div>
          </div>
          
          <!-- Gasto máximo -->
          <div class="bg-gradient-to-br from-red-50 to-red-100 rounded-lg shadow-lg p-5 border border-red-200 transform transition-transform duration-300 hover:scale-[1.02] overflow-hidden relative">
            <div class="absolute top-0 right-0 -mt-4 -mr-4 bg-red-500 rounded-full w-20 h-20 opacity-20"></div>
            <div class="flex justify-between items-center">
              <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                <i class="fas fa-arrow-up text-red-600 mr-2 text-3xl"></i>
                <span>Máximo</span>
              </h2>
              <span class="text-3xl font-bold text-red-600">${{ gasto_maximo|floatformat:2|intcomma }}</span>
            </div>
            <p class="text-gray-600 mt-2 italic">Categoría: {{ categoria_gasto_maximo }}</p>
          </div>
        </div>
      </div>

      <!-- Gráfico de barras horizontal -->
      <div class="bg-white rounded-lg shadow-lg p-4 border border-gray-100">
        <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
          <i class="fas fa-chart-bar text-amber-500 mr-2"></i> Gastos por Categoría
        </h2>
        <div style="height: 300px;" class="mt-2">
          <canvas id="gastosCategoriasChart"></canvas>
        </div>
      </div>
    </div>
    
    <!-- Otras gráficas y contenido -->
    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-8">
      <!-- Gasto mínimo -->
      <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg shadow-lg p-5 border border-green-200 transform transition-transform duration-300 hover:scale-[1.02] overflow-hidden relative">
        <div class="absolute top-0 right-0 -mt-4 -mr-4 bg-green-500 rounded-full w-20 h-20 opacity-20"></div>
        <div class="flex justify-between items-center">
          <h2 class="text-xl font-semibold text-gray-800 flex items-center">
            <i class="fas fa-arrow-down text-green-600 mr-2 text-3xl"></i>
            <span>Mínimo</span>
          </h2>
          <span class="text-3xl font-bold text-green-600">${{ gasto_minimo|floatformat:2|intcomma }}</span>
        </div>
        <p class="text-gray-600 mt-2 italic">Categoría: {{ categoria_gasto_minimo }}</p>
      </div>
      
      <!-- Gasto mediano -->
      <div class="bg-gradient-to-br from-amber-50 to-amber-100 rounded-lg shadow-lg p-5 border border-amber-200 transform transition-transform duration-300 hover:scale-[1.02] overflow-hidden relative">
        <div class="absolute top-0 right-0 -mt-4 -mr-4 bg-amber-500 rounded-full w-20 h-20 opacity-20"></div>
        <div class="flex justify-between items-center">
          <h2 class="text-xl font-semibold text-gray-800 flex items-center">
            <i class="fas fa-equals text-amber-600 mr-2 text-3xl"></i>
            <span>Media</span>
          </h2>
          <span class="text-3xl font-bold text-amber-600">${{ gasto_mediano|floatformat:2|intcomma }}</span>
        </div>
      </div>

      <!-- Gráfico de distribución de gastos -->
      <div class="lg:col-span-3 bg-white rounded-lg shadow-lg p-4 border border-gray-100">
        <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
          <i class="fas fa-chart-pie text-indigo-500 mr-2"></i> Distribución de Gastos
        </h2>
        <div style="height: 200px;" class="mt-2">
          <canvas id="distribucionGastosChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Tabla de datos -->
    <div class="bg-white rounded-lg shadow-lg p-6 border border-gray-100 mb-8">
      <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
        <i class="fas fa-table text-blue-500 mr-2"></i> Detalle de Gastos
      </h2>
      
      <div class="overflow-x-auto">
        {% if balances %}
        <table id="gastosTable" class="display responsive nowrap min-w-full bg-white border-collapse hover stripe" style="width:100%">
          <thead>
            <tr class="bg-gradient-to-r from-gray-100 to-gray-200 text-gray-700">
              <th class="px-4 py-3 text-left">ID</th>
              <th class="px-4 py-3 text-left">Cuenta</th>
              <th class="px-4 py-3 text-left">Numero de la Cuenta</th>
              <th class="px-4 py-3 text-left">Banco</th>
              <th class="px-4 py-3 text-left">Sucursal</th>
              <th class="px-4 py-3 text-left">Categoría</th>
              <th class="px-4 py-3 text-left">Fecha</th>
              <th class="px-4 py-3 text-right">Total Gastos</th>
              <th class="px-4 py-3 text-right">Acumulado</th>
            </tr>
          </thead>
          <tbody>
            {% for balance in balances %}
            <tr class="text-gray-700 border-b border-gray-200 hover:bg-blue-50 transition-colors duration-150">
              <td class="px-4 py-3 font-mono text-sm">{{ balance.id }}</td>
              <td class="px-4 py-3">{{ balance.id_cuenta_banco__id }}</td>
              <td class="px-4 py-3">{{ balance.id_cuenta_banco__numero_cuenta }}</td>
              <td class="px-4 py-3">{{ balance.id_cuenta_banco__id_banco__nombre }}</td>
              <td class="px-4 py-3">{{ balance.id_cuenta_banco__id_sucursal__nombre }}</td>
              <td class="px-4 py-3">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                  {{ balance.id_cat_gastos__nombre }}
                </span>
              </td>
              <td class="px-4 py-3">
                {% if selected_periodo == 'diario' %}
                  {{ balance.fecha|date:"Y-m-d" }}
                {% elif selected_periodo == 'semanal' %}
                  {{ balance.semana|date:"Y-m-d" }}
                {% elif selected_periodo == 'mensual' %}
                  {{ balance.mes|date:"Y-m" }}
                {% endif %}
              </td>
              <td class="px-4 py-3 text-right font-medium text-blue-600" data-order="{{ balance.total_gastos }}">
                ${{ balance.total_gastos|floatformat:2 }}
              </td>
              <td class="px-4 py-3 text-right font-medium text-green-600" data-order="{{ balance.acumulado }}">
                ${{ balance.acumulado|floatformat:2 }}
              </td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr class="bg-gradient-to-r from-blue-50 to-blue-100 font-semibold text-gray-800">
              <th colspan="7" class="px-4 py-3 text-right">Total:</th>
              <th class="px-4 py-3 text-right text-blue-600">${{ total_gastos|floatformat:2 }}</th>
              <th class="px-4 py-3"></th>
            </tr>
          </tfoot>
        </table>
        {% else %}
        <div class="text-center py-8 bg-white border border-gray-200 rounded-lg">
          <i class="fas fa-exclamation-circle text-gray-400 text-4xl mb-4"></i>
          <p class="text-gray-600 text-lg">No hay datos disponibles para mostrar</p>
          <p class="text-gray-500 mt-2">Intente modificar los filtros para ver resultados</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
{% endblock content %}

{% block extra_js %}
{{ block.super }}
<!-- Incluir Chart.js y DataTables con todas sus extensiones -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="//cdn.datatables.net/2.2.2/js/dataTables.min.js"></script>
<!-- Extensiones de DataTables -->
<script src="//cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="//cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="//cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
<script src="//cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<!-- Librería JSZip para exportación Excel -->
<script src="//cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<!-- Librería PDFMake para exportación PDF -->
<script src="//cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.70/pdfmake.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.70/vfs_fonts.js"></script>



<!-- Script para funciones generales -->
<script>
  // Funciones para el toast de notificación
  function showToast(title, message, duration = 4000) {
    const toast = document.getElementById('toast-notification');
    const toastTitle = document.getElementById('toast-title');
    const toastMessage = document.getElementById('toast-message');
    
    // Actualizar contenido del toast
    toastTitle.textContent = title;
    toastMessage.textContent = message;
    
    // Mostrar el toast
    toast.classList.remove('translate-x-full', 'opacity-0');
    toast.classList.add('translate-x-0', 'opacity-100');

    // Auto-ocultar después de 4 segundos
    setTimeout(function() {
      hideToast();
    }, duration);
  }
  
  function hideToast() {
    const toast = document.getElementById('toast-notification');
    toast.classList.remove('translate-x-0', 'opacity-0');
    toast.classList.add('translate-x-full', 'opacity-100');
  }
  
  // Mostrar toast al cargar la página si hay parámetros de filtro
  function checkAndShowFilterToast() {
    const urlParams = new URLSearchParams(window.location.search);
    const hasFilters = urlParams.has('cuenta_id') || urlParams.has('year') || 
                      urlParams.has('month') || urlParams.has('periodo') || 
                      urlParams.has('dia') || urlParams.has('fecha_inicio') || 
                      urlParams.has('fecha_fin');
    
    if (hasFilters) {
      const activeFilters = [];
      
      if (urlParams.get('cuenta_id')) {
        const cuentaSelect = document.getElementById('cuenta_id');
        const selectedOption = cuentaSelect.options[cuentaSelect.selectedIndex];
        activeFilters.push(`Cuenta: ${selectedOption.text}`);
      }
      
      if (urlParams.get('year')) {
        activeFilters.push(`Año: ${urlParams.get('year')}`);
      }
      
      if (urlParams.get('month')) {
        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
                           "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        const monthIndex = parseInt(urlParams.get('month')) - 1;
        if (monthIndex >= 0 && monthIndex < 12) {
          activeFilters.push(`Mes: ${monthNames[monthIndex]}`);
        }
      }
      
      if (urlParams.get('periodo')) {
        const periodos = { 'diario': 'Diario', 'semanal': 'Semanal', 'mensual': 'Mensual' };
        activeFilters.push(`Periodo: ${periodos[urlParams.get('periodo')] || urlParams.get('periodo')}`);
      }
      
      if (urlParams.get('dia')) {
        activeFilters.push(`Día: ${urlParams.get('dia')}`);
      }
      
      if (urlParams.get('fecha_inicio') && urlParams.get('fecha_fin')) {
        activeFilters.push(`Rango: ${urlParams.get('fecha_inicio')} - ${urlParams.get('fecha_fin')}`);
      }
      
      let message = 'Filtros aplicados: ' + activeFilters.join(', ');
      if (message.length > 100) {
        message = `${activeFilters.length} filtros aplicados correctamente.`;
      }
      
      setTimeout(function() {
        showToast('¡Filtros aplicados!', message);
      }, 500);
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
    // Ocultar el mensaje de advertencia después de 5 segundos
    setTimeout(function() {
      document.getElementById("warning-message").style.display = "none";
    }, 5000);

    // Gestionar la visualización de los filtros de fecha según el periodo
    document.getElementById('periodo').addEventListener('change', function() {
      const diaContainer = document.getElementById('dia-container');
      if (this.value === 'diario') {
        diaContainer.style.display = 'flex';
      } else {
        diaContainer.style.display = 'none';
      }
    });
    
    // Mostrar notificación toast cuando se aplican filtros (al enviar el formulario)
    const filterForm = document.querySelector('form[action="{% url "balances" %}"]');
    if (filterForm) {
      filterForm.addEventListener('submit', function(e) {
        // Mostrar toast de carga inmediatamente
        showToast('Aplicando filtros...', 'Actualizando la información según los criterios seleccionados.');
      });
    }
    
    // Mostrar toast si hay filtros aplicados al cargar la página
    checkAndShowFilterToast();
  });
</script>

<!-- Script para inicialización de gráficos -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    console.log("Inicializando gráficos...");
    
    // Crear gráfico de barras horizontal para categorías
    var ctxCategorias = document.getElementById('gastosCategoriasChart');
    if (!ctxCategorias) {
      console.error("No se encontró el elemento canvas para el gráfico de categorías");
      return;
    }
    
    ctxCategorias = ctxCategorias.getContext('2d');
    
    // Colores para las categorías
    var colors = [
      'rgba(54, 162, 235, 0.7)',
      'rgba(255, 99, 132, 0.7)',
      'rgba(255, 206, 86, 0.7)',
      'rgba(75, 192, 192, 0.7)',
      'rgba(153, 102, 255, 0.7)',
      'rgba(255, 159, 64, 0.7)',
      'rgba(199, 199, 199, 0.7)',
      'rgba(83, 102, 255, 0.7)',
      'rgba(40, 159, 64, 0.7)',
      'rgba(210, 199, 199, 0.7)'
    ];
    
    // Extraer categorías y totales de los balances
    var categorias = {};
    {% for balance in balances %}
      var categoria = "{{ balance.id_cat_gastos__nombre }}";
      var monto = parseFloat("{{ balance.total_gastos }}");
      
      if (categorias[categoria]) {
        categorias[categoria] += monto;
      } else {
        categorias[categoria] = monto;
      }
    {% endfor %}
    
    console.log("Categorías extraídas:", categorias);
    
    // Convertir a arrays para Chart.js
    var labels = [];
    var data = [];
    var backgroundColors = [];
    
    var i = 0;
    for (var key in categorias) {
      if (categorias.hasOwnProperty(key)) {
        labels.push(key);
        data.push(categorias[key]);
        backgroundColors.push(colors[i % colors.length]);
        i++;
      }
    }
    
    console.log("Datos preparados para gráficos:", { labels, data });
    
    // Ordenar los datos de mayor a menor
    var combinado = [];
    for (var j = 0; j < labels.length; j++) {
      combinado.push({ label: labels[j], data: data[j], color: backgroundColors[j] });
    }
    
    combinado.sort(function(a, b) {
      return b.data - a.data;
    });
    
    labels = combinado.map(function(item) { return item.label; });
    data = combinado.map(function(item) { return item.data; });
    backgroundColors = combinado.map(function(item) { return item.color; });
    
    // Crear el gráfico de barras horizontal
    if (labels.length > 0) {
      console.log("Creando gráfico de barras con:", labels.length, "categorías");
      
      try {
        new Chart(ctxCategorias, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Gastos por Categoría',
              data: data,
              backgroundColor: backgroundColors,
              borderColor: backgroundColors.map(color => color.replace('0.7', '1')),
              borderWidth: 1,
              borderRadius: 4,
              maxBarThickness: 30
            }]
          },
          options: {
            indexAxis: 'y',  // Hacer el gráfico horizontal
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return '$' + new Intl.NumberFormat('es-MX').format(context.parsed.x.toFixed(2));
                  }
                }
              }
            },
            scales: {
              x: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return '$' + value.toLocaleString();
                  }
                }
              },
              y: {
                ticks: {
                  font: {
                    weight: 'bold'
                  }
                }
              }
            },
            animation: {
              duration: 2000,
              easing: 'easeOutQuart'
            }
          }
        });
        console.log("Gráfico de barras creado exitosamente");
      } catch (error) {
        console.error("Error al crear el gráfico de barras:", error);
      }
    } else {
      console.warn("No hay datos para el gráfico de barras");
      document.querySelector('#gastosCategoriasChart').closest('div').innerHTML = '<div class="flex flex-col items-center justify-center h-full"><i class="fas fa-info-circle text-gray-300 text-4xl mb-2"></i><p class="text-gray-500">No hay datos disponibles para mostrar</p></div>';
    }
    
    // Gráfico de distribución de gastos (pie chart)
    var ctxDistribucion = document.getElementById('distribucionGastosChart');
    
    if (ctxDistribucion && labels.length > 0) {
      ctxDistribucion = ctxDistribucion.getContext('2d');
      console.log("Creando gráfico de distribución...");
      
      try {
        new Chart(ctxDistribucion, {
          type: 'doughnut',
          data: {
            labels: labels,
            datasets: [{
              data: data,
              backgroundColor: backgroundColors,
              borderColor: backgroundColors.map(color => color.replace('0.7', '1')),
              borderWidth: 1,
              hoverOffset: 10
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'right',
                labels: {
                  boxWidth: 12,
                  padding: 10
                }
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    var label = context.label || '';
                    var value = context.parsed || 0;
                    var total = context.dataset.data.reduce((a, b) => a + b, 0);
                    var percentage = ((value * 100) / total).toFixed(1);
                    return label + ': $' + value.toLocaleString() + ' (' + percentage + '%)';
                  }
                }
              }
            },
            animation: {
              animateRotate: true,
              animateScale: true,
              duration: 1500
            }
          }
        });
        console.log("Gráfico de distribución creado exitosamente");
      } catch (error) {
        console.error("Error al crear el gráfico de distribución:", error);
      }
    } else if (ctxDistribucion) {
      console.warn("No hay datos para el gráfico de distribución");
      document.querySelector('#distribucionGastosChart').closest('div').innerHTML = '<div class="flex flex-col items-center justify-center h-full"><i class="fas fa-info-circle text-gray-300 text-4xl mb-2"></i><p class="text-gray-500">No hay datos disponibles para mostrar</p></div>';
    }
  });
</script>

<!-- Script para inicialización de DataTables -->
<script>
  // Función auxiliar para formatear números desde el DOM
  function formatNumericValue(node, includeSymbol) {
    var dataOrder = node.getAttribute('data-order');
    console.log('dataOrder value:', dataOrder);
    
    if (dataOrder) {
      // Convertir coma decimal a punto para parseFloat (formato europeo → estadounidense)
      var normalizedValue = dataOrder.replace(',', '.');
      var numValue = parseFloat(normalizedValue);
      
      if (!isNaN(numValue)) {
        var formatted = numValue.toFixed(2);
        return includeSymbol ? '$' + formatted : formatted;
      }
    }
    
    // Si no hay data-order válido, extraer el número del texto
    var textContent = node.textContent || node.innerText || '';
    console.log('textContent:', textContent);
    
    // Limpiar el texto: remover símbolo de moneda y espacios
    var cleanNumber = textContent.replace(/[$\s]/g, '');
    console.log('cleanNumber after removing $ and spaces:', cleanNumber);
    
    // Si usa coma como separador decimal (formato europeo), convertir a punto
    if (cleanNumber.indexOf(',') > cleanNumber.lastIndexOf('.')) {
      cleanNumber = cleanNumber.replace(/\./g, '').replace(',', '.');
      console.log('European format detected, converted to:', cleanNumber);
    } else {
      // Si usa punto como separador decimal, remover comas de miles
      cleanNumber = cleanNumber.replace(/,/g, '');
      console.log('US format detected, cleaned to:', cleanNumber);
    }
    
    var numValue = parseFloat(cleanNumber);
    var result = isNaN(numValue) ? '0.00' : numValue.toFixed(2);
    console.log('Final parsed value:', result);
    
    return includeSymbol ? '$' + result : result;
  }

  document.addEventListener('DOMContentLoaded', function() {
    console.log("Inicializando DataTable...");
    
    try {
      new DataTable('#gastosTable', {
        language: {
          processing: "Procesando...",
          search: "Buscar:",
          lengthMenu: "Mostrar _MENU_ registros",
          info: "Mostrando _START_ a _END_ de _TOTAL_ registros",
          infoEmpty: "Mostrando 0 a 0 de 0 registros",
          infoFiltered: "(filtrado de _MAX_ registros totales)",
          loadingRecords: "Cargando...",
          zeroRecords: "No se encontraron registros coincidentes",
          emptyTable: "No hay datos disponibles en la tabla",
          paginate: {
            first: "Primero",
            previous: "Anterior",
            next: "Siguiente",
            last: "Último"
          },
          buttons: {
            copy: "Copiar",
            print: "Imprimir",
            excel: "Excel",
            pdf: "PDF",
            csv: "CSV"
          }
        },
        columnDefs: [
          {
            targets: [5], // Columna "Categoría" (ahora es la columna 5)
            render: function(data, type, row) {
              if (type === 'export' || type === 'copy') {
                // Para exportación, extraer solo el texto del span
                var tempDiv = document.createElement('div');
                tempDiv.innerHTML = data;
                return tempDiv.textContent || tempDiv.innerText || '';
              }
              // Para visualización, mantener el HTML original
              return data;
            }
          }
        ],
        buttons: [
          {
            extend: 'copy',
            className: 'dt-button btn-copy',
            text: '<i class="fas fa-copy mr-1"></i> Copiar',
            exportOptions: {
              format: {
                body: function(data, row, column, node) {
                  // Para la columna de categoría, extraer solo el texto
                  if (column === 5) {
                    var tempDiv = document.createElement('div');
                    tempDiv.innerHTML = data;
                    return tempDiv.textContent || tempDiv.innerText || '';
                  }
                  // Para las columnas numéricas (ahora son 7 y 8), usar la función auxiliar
                  if (column === 7 || column === 8) {
                    console.log('Processing column', column, 'for copy export');
                    return formatNumericValue(node, false);
                  }
                  return data;
                }
              }
            }
          },
          {
            extend: 'csv',
            className: 'dt-button btn-csv',
            text: '<i class="fas fa-file-csv mr-1"></i> CSV',
            exportOptions: {
              format: {
                body: function(data, row, column, node) {
                  // Para la columna de categoría, extraer solo el texto
                  if (column === 5) {
                    var tempDiv = document.createElement('div');
                    tempDiv.innerHTML = data;
                    return tempDiv.textContent || tempDiv.innerText || '';
                  }
                  // Para las columnas numéricas (ahora son 7 y 8), usar la función auxiliar
                  if (column === 7 || column === 8) {
                    console.log('Processing column', column, 'for CSV export');
                    return formatNumericValue(node, false);
                  }
                  return data;
                }
              }
            }
          },
          {
            extend: 'excel',
            className: 'dt-button btn-excel',
            text: '<i class="fas fa-file-excel mr-1"></i> Excel',
            exportOptions: {
              format: {
                body: function(data, row, column, node) {
                  // Para la columna de categoría, extraer solo el texto
                  if (column === 5) {
                    var tempDiv = document.createElement('div');
                    tempDiv.innerHTML = data;
                    return tempDiv.textContent || tempDiv.innerText || '';
                  }
                  // Para las columnas numéricas (ahora son 7 y 8), usar la función auxiliar
                  if (column === 7 || column === 8) {
                    console.log('Processing column', column, 'for Excel export');
                    return formatNumericValue(node, false);
                  }
                  return data;
                }
              }
            }
          },
          {
            extend: 'pdf',
            className: 'dt-button btn-pdf',
            text: '<i class="fas fa-file-pdf mr-1"></i> PDF',
            exportOptions: {
              format: {
                body: function(data, row, column, node) {
                  // Para la columna de categoría, extraer solo el texto
                  if (column === 5) {
                    var tempDiv = document.createElement('div');
                    tempDiv.innerHTML = data;
                    return tempDiv.textContent || tempDiv.innerText || '';
                  }
                  // Para las columnas numéricas (ahora son 7 y 8), usar la función auxiliar
                  if (column === 7 || column === 8) {
                    console.log('Processing column', column, 'for PDF export');
                    return formatNumericValue(node, true);
                  }
                  return data;
                }
              }
            }
          },
          {
            extend: 'print',
            className: 'dt-button btn-print',
            text: '<i class="fas fa-print mr-1"></i> Imprimir',
            exportOptions: {
              format: {
                body: function(data, row, column, node) {
                  // Para la columna de categoría, extraer solo el texto
                  if (column === 5) {
                    var tempDiv = document.createElement('div');
                    tempDiv.innerHTML = data;
                    return tempDiv.textContent || tempDiv.innerText || '';
                  }
                  // Para las columnas numéricas (ahora son 7 y 8), usar la función auxiliar
                  if (column === 7 || column === 8) {
                    console.log('Processing column', column, 'for print export');
                    return formatNumericValue(node, true);
                  }
                  return data;
                }
              }
            }
          }
        ],
        dom: '<"flex justify-between items-center mb-4"<"flex-1"B><"flex items-center gap-4"l f>>rt<"flex justify-between items-center mt-4"<"flex-1"i><"flex-1 text-center"p>>',
        responsive: true,
        order: [[6, "desc"]], // Columna de fecha (ahora es la 6)
        paging: true,
        pageLength: 25,
        lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Todos"]],
        pagingType: 'full_numbers',
        processing: true,
        searching: true,
        info: true,
        // Forzar mostrar paginación incluso con pocos registros para testing
        pagingInfo: true,
        initComplete: function() {
          console.log("DataTable inicializado, configurando estilos...");
          
          // Aplicar estilos a los botones después de que la tabla se haya inicializado completamente
          var buttonsContainer = document.querySelector('.dt-buttons');
          if (buttonsContainer) {
            buttonsContainer.style.display = 'flex';
            buttonsContainer.style.flexWrap = 'wrap';
            buttonsContainer.style.gap = '8px';
          }
          
          // Aplicar estilos específicos a cada botón
          setTimeout(function() {
            document.querySelectorAll('.dt-button').forEach(function(btn) {
              btn.style.fontFamily = 'inherit';
              btn.style.fontSize = '14px';
              btn.style.lineHeight = '1.5';
              btn.style.transition = 'all 0.2s ease';
              btn.style.cursor = 'pointer';
            });
            
            // Estilar los controles de paginación
            stylePaginationControls();
            
            // Estilar el selector de cantidad de registros
            styleLengthMenu();
            
            // Debug: verificar que los botones de paginación estén presentes
            var paginationButtons = document.querySelectorAll('.paginate_button');
            console.log("Botones de paginación encontrados:", paginationButtons.length);
            paginationButtons.forEach(function(btn, index) {
              console.log(`Botón ${index}:`, btn.textContent, btn.className);
            });
            
          }, 100);
        },
        drawCallback: function() {
          // Re-aplicar estilos cada vez que se redibuje la tabla
          setTimeout(function() {
            stylePaginationControls();
            console.log("Tabla redibujada, estilos de paginación reaplicados");
          }, 50);
        }
      });
      
      // Función para estilar controles de paginación
      function stylePaginationControls() {
        // Los estilos ahora están manejados por CSS, solo necesitamos asegurar visibilidad
        var paginateContainer = document.querySelector('.dataTables_paginate');
        if (paginateContainer) {
          paginateContainer.style.display = 'block';
          paginateContainer.style.textAlign = 'center';
        }
        
        // Asegurar que todos los botones sean visibles
        document.querySelectorAll('.paginate_button').forEach(function(button) {
          button.style.display = 'inline-block';
          button.style.visibility = 'visible';
        });
      }
      
      // Función para estilar el selector de cantidad de registros
      function styleLengthMenu() {
        var lengthSelect = document.querySelector('.dataTables_length select');
        if (lengthSelect) {
          lengthSelect.style.backgroundColor = 'white';
          lengthSelect.style.border = '1px solid #d1d5db';
          lengthSelect.style.borderRadius = '6px';
          lengthSelect.style.padding = '6px 12px';
          lengthSelect.style.fontSize = '14px';
          lengthSelect.style.color = '#374151';
          lengthSelect.style.marginLeft = '8px';
          lengthSelect.style.marginRight = '8px';
        }
        
        var lengthLabel = document.querySelector('.dataTables_length');
        if (lengthLabel) {
          lengthLabel.style.fontSize = '14px';
          lengthLabel.style.color = '#6b7280';
          lengthLabel.style.fontWeight = '500';
        }
      }
      
      // Re-aplicar estilos cuando se actualice la paginación usando drawCallback en lugar de evento separado
      
      // Aplicar estilos adicionales a los botones de DataTables después de la inicialización
      setTimeout(function() {
        // Botón Copiar
        var copyBtn = document.querySelector('.dt-button.btn-copy');
        if (copyBtn) {
          copyBtn.style.backgroundColor = '#3B82F6';
          copyBtn.style.color = 'white';
          copyBtn.style.border = 'none';
          copyBtn.style.padding = '6px 12px';
          copyBtn.style.borderRadius = '6px';
          copyBtn.style.marginRight = '8px';
          copyBtn.style.fontWeight = '500';
        }
        
        // Botón CSV
        var csvBtn = document.querySelector('.dt-button.btn-csv');
        if (csvBtn) {
          csvBtn.style.backgroundColor = '#10B981';
          csvBtn.style.color = 'white';
          csvBtn.style.border = 'none';
          csvBtn.style.padding = '6px 12px';
          csvBtn.style.borderRadius = '6px';
          csvBtn.style.marginRight = '8px';
          csvBtn.style.fontWeight = '500';
        }
        
        // Botón Excel
        var excelBtn = document.querySelector('.dt-button.btn-excel');
        if (excelBtn) {
          excelBtn.style.backgroundColor = '#059669';
          excelBtn.style.color = 'white';
          excelBtn.style.border = 'none';
          excelBtn.style.padding = '6px 12px';
          excelBtn.style.borderRadius = '6px';
          excelBtn.style.marginRight = '8px';
          excelBtn.style.fontWeight = '500';
        }
        
        // Botón PDF
        var pdfBtn = document.querySelector('.dt-button.btn-pdf');
        if (pdfBtn) {
          pdfBtn.style.backgroundColor = '#EF4444';
          pdfBtn.style.color = 'white';
          pdfBtn.style.border = 'none';
          pdfBtn.style.padding = '6px 12px';
          pdfBtn.style.borderRadius = '6px';
          pdfBtn.style.marginRight = '8px';
          pdfBtn.style.fontWeight = '500';
        }
        
        // Botón Imprimir
        var printBtn = document.querySelector('.dt-button.btn-print');
        if (printBtn) {
          printBtn.style.backgroundColor = '#8B5CF6';
          printBtn.style.color = 'white';
          printBtn.style.border = 'none';
          printBtn.style.padding = '6px 12px';
          printBtn.style.borderRadius = '6px';
          printBtn.style.marginRight = '8px';
          printBtn.style.fontWeight = '500';
        }
      }, 100);
      
      console.log("DataTable inicializado exitosamente");
    } catch (error) {
      console.error("Error al inicializar DataTable:", error);
    }
  });
</script>
{% endblock %}
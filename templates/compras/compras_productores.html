{% extends "_base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Gestión de Compras a Productores{% endblock %}

{% block extra_css %}
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/select/1.7.0/css/select.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/searchpanes/2.2.0/css/searchPanes.dataTables.min.css">
    <!-- DateRangePicker -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    <style>
        .filter-btn {
            transition: all 0.3s ease;
        }
        .filter-btn.active {
            background-color: #065f46;
            color: white;
        }
        .daterangepicker {
            z-index: 1050 !important;
        }
        /* Estilos para DataTables */
        .dataTables_wrapper {
            @apply bg-white rounded-lg p-4 shadow-sm;
        }
        .dataTables_filter input {
            @apply pl-8 border border-gray-300 rounded-md outline-none focus:ring-2 focus:ring-blue-500 py-1 px-2;
            background-position: 10px center;
            background-repeat: no-repeat;
            background-size: 14px;
        }
        .dataTables_length select {
            @apply border border-gray-300 rounded-md outline-none focus:ring-2 focus:ring-blue-500 py-1 pl-2 pr-8;
        }
        .dataTables_paginate .paginate_button {
            @apply px-3 py-1 mx-1 rounded-md border border-gray-200 hover:bg-blue-500 hover:text-white transition-colors duration-200;
        }
        .dataTables_paginate .paginate_button.current {
            @apply bg-blue-500 text-white border-blue-500;
        }
        .dataTables_paginate .paginate_button.disabled {
            @apply opacity-50 cursor-not-allowed;
        }
        table.dataTable tbody tr.selected {
            @apply bg-blue-100;
        }
        .buttons-collection {
            @apply relative;
        }
        .dt-button-collection {
            @apply absolute bg-white shadow-lg rounded-lg p-2 z-10 mt-1 w-40;
        }
        .dt-button-collection .dt-button {
            @apply block w-full text-left px-3 py-2 hover:bg-gray-100 rounded-md my-1;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="container mx-auto p-4">

           <!-- Tarjetas de acumulados -->
    <div class="bg-white rounded-lg shadow-md p-4 mb-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">
            <i class="fas fa-chart-line text-blue-600 mr-2"></i>Acumulados de Compras
            <span id="acumulados-filtro-indicador" class="text-sm font-normal text-gray-500 ml-2 hidden">(Filtrado)</span>
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-gray-50 p-4 rounded-md border border-gray-200">
                <h3 class="font-semibold text-lg">Total Compras</h3>
                <p id="total-compras" class="text-xl font-bold text-green-600" data-total="{{ total_compras|default:0 }}">
                    ${{ total_compras|floatformat:2|intcomma }}
                </p>
                <p id="total-compras-label" class="text-sm text-gray-500">Acumulado histórico</p>
            </div>
            <div class="bg-gray-50 p-4 rounded-md border border-gray-200">
                <h3 class="font-semibold text-lg">Acumulado Diario</h3>
                <p id="acumulado-diario" class="text-xl font-bold text-blue-600" data-total="{{ compras_hoy|default:0 }}">
                    ${{ compras_hoy|default:"0.00"|floatformat:2|intcomma }}
                </p>
                <p class="text-sm text-gray-500">Compras del día</p>
            </div>
            <div class="bg-gray-50 p-4 rounded-md border border-gray-200">
                <h3 class="font-semibold text-lg">Compras del Mes</h3>
                <p id="acumulado-mensual" class="text-xl font-bold text-indigo-600" data-total="{{ compras_mes_actual|default:0 }}">
                    ${{ compras_mes_actual|floatformat:2|intcomma }}
                </p>
                <p class="text-sm text-gray-500">{{ now|date:"F Y" }}</p>
            </div>
            <div class="bg-gray-50 p-4 rounded-md border border-gray-200">
                <h3 class="font-semibold text-lg">Total Productores</h3>
                <p class="text-xl font-bold text-purple-600">{{ productores.count }}</p>
                <p class="text-sm text-gray-500">Activos en el sistema</p>
            </div>
        </div>
    </div>
        
        <!-- Compras por tipo de pago -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">
                <i class="fas fa-credit-card text-green-600 mr-2"></i>Compras por Tipo de Pago
                <span id="filtro-indicador" class="text-sm font-normal text-gray-500 ml-2 hidden">(Filtrado)</span>
            </h2>
            <div id="compras-tipo-pago-container" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                {% for tipo in compras_por_tipo %}
                <div class="bg-gray-50 p-3 rounded-md border border-gray-200"
                    data-tipo-pago="{{ tipo.tipo_pago|default:'No definido' }}">
                    <h3 class="font-semibold text-lg">{{ tipo.tipo_pago|default:"No definido" }}</h3>
                    <p class="text-xl font-bold text-green-600 monto-tipo-pago">${{ tipo.total|floatformat:2|intcomma }}</p>
                    <p class="text-sm text-gray-500"><span class="cantidad-transacciones">{{ tipo.cantidad }}</span>
                        transacciones</p>
                </div>
                {% empty %}
                <div class="col-span-4 text-center py-4 text-gray-500">
                    No hay datos disponibles
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Historial de compras con filtros -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <div class="flex flex-col md:flex-row md:justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">
                    <i class="fas fa-history text-purple-600 mr-2"></i>Historial de Compras
                </h2>
                
                <!-- Panel de filtros de fecha -->
                <div class="w-full md:w-auto mt-3 md:mt-0">
                    <div class="flex flex-wrap items-center gap-2">
                        <div class="relative">
                            <input type="text" id="daterange" class="border border-gray-300 rounded-md px-3 py-2 text-sm w-60" 
                                placeholder="Seleccionar rango de fechas">
                            <button id="clearDateFilter" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700" title="Limpiar filtro">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="flex space-x-1">
                            <button id="filterToday" class="filter-btn px-3 py-2 text-xs border border-green-600 text-green-600 rounded-md hover:bg-green-600 hover:text-white">
                                Hoy
                            </button>
                            <button id="filterWeek" class="filter-btn px-3 py-2 text-xs border border-green-600 text-green-600 rounded-md hover:bg-green-600 hover:text-white">
                                Esta semana
                            </button>
                            <button id="filterMonth" class="filter-btn px-3 py-2 text-xs border border-green-600 text-green-600 rounded-md hover:bg-green-600 hover:text-white">
                                Este mes
                            </button>
                            <button id="filterYear" class="filter-btn px-3 py-2 text-xs border border-green-600 text-green-600 rounded-md hover:bg-green-600 hover:text-white">
                                Este año
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        
            <div class="overflow-x-auto">
                <table id="tablaCompras" class="min-w-full bg-white">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="py-2 px-3 text-left">ID</th>
                            <th class="py-2 px-3 text-left">Fecha</th>
                            <th class="py-2 px-3 text-left">Productor</th>
                            <th class="py-2 px-3 text-left">Producto</th>
                            <th class="py-2 px-3 text-right">Cantidad</th>
                            <th class="py-2 px-3 text-right">Precio Unit.</th>
                            <th class="py-2 px-3 text-right">Total</th>
                            <th class="py-2 px-3 text-center">Tipo Pago</th>
                            <th class="py-2 px-3 text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for compra in compras %}
                        <tr class="border-t hover:bg-gray-50">
                            <td class="py-2 px-3">{{ compra.id }}</td>
                            <td class="py-2 px-3">{{ compra.fecha_compra|date:"d/m/Y" }}</td>
                            <td class="py-2 px-3">{{ compra.productor.nombre_completo }}</td>
                            <td class="py-2 px-3">{{ compra.producto.nombre }} - {{ compra.producto.variedad }}</td>
                            <td class="py-2 px-3 text-right">{{ compra.cantidad }}</td>
                            <td class="py-2 px-3 text-right">${{ compra.precio_unitario|floatformat:2|intcomma }}</td>
                            <td class="py-2 px-3 text-right font-semibold">${{ compra.monto_total|floatformat:2|intcomma }}</td>
                            <td class="py-2 px-3 text-center">
                                {% if compra.tipo_pago == 'Efectivo' %}
                                <span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">Efectivo</span>
                                {% elif compra.tipo_pago == 'Deposito' %}
                                <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">Depósito</span>
                                {% elif compra.tipo_pago == 'Transferencia' %}
                                <span class="px-2 py-1 bg-purple-100 text-purple-800 rounded-full text-xs">Transferencia</span>
                                {% elif compra.tipo_pago == 'Cheque' %}
                                <span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs">Cheque</span>
                                {% else %}
                                <span class="px-2 py-1 bg-gray-100 text-gray-800 rounded-full text-xs">No definido</span>
                                {% endif %}
                            </td>
                            <td class="py-2 px-3 text-center">
                                <a href="#" class="text-blue-600 hover:text-blue-800 mx-1" title="Ver detalles"
                                    data-id="{{ compra.id }}">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="#" class="text-green-600 hover:text-green-800 mx-1" title="Editar"
                                    data-id="{{ compra.id }}">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a href="#" class="text-red-600 hover:text-red-800 mx-1" title="Eliminar"
                                    data-id="{{ compra.id }}">
                                    <i class="fas fa-trash-alt"></i>
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="9" class="py-4 text-center text-gray-500">No hay compras registradas</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

                <!-- Gráfico de compras mensuales -->
                <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4"><i class="fas fa-chart-bar text-indigo-600 mr-2"></i>Tendencia
                        de Compras (Últimos 6 meses)</h2>
                    <div class="h-64">
                        <canvas id="comprasMensualesChart"></canvas>
                    </div>
                </div>


            <!-- Top Productores y Productos Comprados -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Top Productores -->
                <div class="bg-white rounded-lg shadow-md p-4">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4"><i class="fas fa-medal text-yellow-600 mr-2"></i>Top 5
                        Productores</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="py-2 px-3 text-left">Productor</th>
                                    <th class="py-2 px-3 text-right">Total Compras</th>
                                    <th class="py-2 px-3 text-right">Cantidad</th>
                                    <th class="py-2 px-3 text-center">Acción</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for productor in top_productores %}
                                <tr class="border-t hover:bg-gray-50">
                                    <td class="py-2 px-3">{{ productor.productor__nombre_completo }}</td>
                                    <td class="py-2 px-3 text-right">${{ productor.total_compras|floatformat:2|intcomma }}</td>
                                    <td class="py-2 px-3 text-right">{{ productor.cantidad_compras }}</td>
                                    <td class="py-2 px-3 text-center">
                                        <a href="{% url 'detalle_productor_compras' productor.productor__id %}"
                                            class="text-blue-600 hover:text-blue-800">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="py-4 text-center text-gray-500">No hay datos disponibles</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            
                <!-- Productos más Comprados -->
                <div class="bg-white rounded-lg shadow-md p-4">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4"><i
                            class="fas fa-shopping-basket text-orange-600 mr-2"></i>Productos más Comprados</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="py-2 px-3 text-left">Producto</th>
                                    <th class="py-2 px-3 text-right">Cantidad</th>
                                    <th class="py-2 px-3 text-right">Monto Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for producto in productos_comprados %}
                                <tr class="border-t hover:bg-gray-50">
                                    <td class="py-2 px-3">{{ producto.producto__nombre }} {{ producto.producto__variedad }}</td>
                                    <td class="py-2 px-3 text-right">{{ producto.cantidad }}</td>
                                    <td class="py-2 px-3 text-right">${{ producto.total|floatformat:2|intcomma }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="py-4 text-center text-gray-500">No hay datos disponibles</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jQuery y DataTables -->
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/select/1.7.0/js/dataTables.select.min.js"></script>
    <script src="https://cdn.datatables.net/searchpanes/2.2.0/js/dataTables.searchPanes.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.70/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.70/vfs_fonts.js"></script>
    <!-- Moment.js y DateRangePicker -->
    <script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <script>
        // Inicializar DataTables con filtrado de fechas
        $(document).ready(function() {
            // Añadir el método de filtro para rango de fechas
            $.fn.dataTable.ext.search.push(
                function(settings, data, dataIndex) {
                    if (window.startDate === undefined || window.endDate === undefined) return true;
                    
                    // La fecha está en la segunda columna (índice 1) en formato dd/mm/yyyy
                    var dateStr = data[1];
                    if (!dateStr) return false;
                    
                    // Convertir la fecha de la fila a un objeto Date
                    var parts = dateStr.split('/');
                    var rowDate = new Date(parts[2], parts[1]-1, parts[0]);
                    rowDate.setHours(0,0,0,0);
                    
                    // Comparar si está dentro del rango
                    if (rowDate >= window.startDate && rowDate <= window.endDate) {
                        return true;
                    }
                    return false;
                }
            );
            
            // Inicializar DataTables
            const tabla = $('#tablaCompras').DataTable({
                responsive: true,
                pageLength: 10,
                stateSave: true,
                lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Todos"]],
                dom: '<"dt-header"<"dt-header-left"Bl><"dt-header-right"f>><"dt-container"rt><"dt-footer"<"dt-footer-left"i><"dt-footer-right"p>>',
                buttons: [
                    {
                        extend: 'collection',
                        text: '<i class="fas fa-download mr-1"></i> Exportar',
                        className: 'bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded shadow',
                        buttons: [
                            {
                                extend: 'copy',
                                className: 'bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-1 px-3 rounded shadow mr-2',
                                text: '<i class="fas fa-copy mr-1"></i> Copiar'
                            },
                            {
                                extend: 'csv',
                                className: 'bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded shadow mr-2',
                                text: '<i class="fas fa-file-csv mr-1"></i> CSV'
                            },
                            {
                                extend: 'excel',
                                className: 'bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded shadow mr-2',
                                text: '<i class="fas fa-file-excel mr-1"></i> Excel'
                            },
                            {
                                extend: 'pdf',
                                className: 'bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded shadow mr-2',
                                text: '<i class="fas fa-file-pdf mr-1"></i> PDF',
                                orientation: 'landscape',
                                pageSize: 'LEGAL',
                                customize: function(doc) {
                                    doc.defaultStyle.fontSize = 8;
                                    doc.styles.tableHeader.fontSize = 9;
                                    doc.content[1].table.widths = Array(doc.content[1].table.body[0].length + 1).join('*').split('');
                                }
                            },
                            {
                                extend: 'print',
                                className: 'bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded shadow',
                                text: '<i class="fas fa-print mr-1"></i> Imprimir',
                                customize: function(win) {
                                    $(win.document.body).addClass('bg-white');
                                    $(win.document.body).find('table')
                                        .addClass('display')
                                        .css('font-size', '12px');
                                }
                            }
                        ]
                    },
                    {
                        text: '<i class="fas fa-columns mr-1"></i> Columnas',
                        className: 'bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded shadow ml-2',
                        extend: 'colvis'
                    },
                    {
                        text: '<i class="fas fa-sync-alt mr-1"></i> Refrescar',
                        className: 'bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded shadow ml-2',
                        action: function() {
                            tabla.ajax.reload(null, false);
                        }
                    }
                ],
                language: {
                    "processing": "Procesando...",
                    "lengthMenu": "Mostrar _MENU_ registros",
                    "zeroRecords": "No se encontraron resultados",
                    "emptyTable": "Ningún dato disponible en esta tabla",
                    "info": "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
                    "infoEmpty": "Mostrando registros del 0 al 0 de un total de 0 registros",
                    "infoFiltered": "(filtrado de un total de _MAX_ registros)",
                    "search": "<i class='fas fa-search'></i> Buscar:",
                    "infoThousands": ",",
                    "loadingRecords": "<div class='spinner-border text-primary'></div>",
                    "paginate": {
                        "first": '<i class="fas fa-angle-double-left"></i>',
                        "last": '<i class="fas fa-angle-double-right"></i>',
                        "next": '<i class="fas fa-angle-right"></i>',
                        "previous": '<i class="fas fa-angle-left"></i>'
                    }
                },
                order: [[1, 'desc']],
                columnDefs: [
                    { responsivePriority: 1, targets: [1, 2, 3, 4] },
                    { responsivePriority: 2, targets: [8] },
                    { orderable: false, targets: [8] }
                ],
                initComplete: function() {
                    $(this).fadeIn(1000);
                    
                    // Aplicar estilos a elementos de la tabla
                    $('.dataTables_wrapper .dt-header').addClass('flex flex-wrap justify-between items-center mb-4 pb-2 border-b border-gray-200');
                    $('.dataTables_wrapper .dt-header-left').addClass('flex-grow flex-shrink-0 mb-2 md:mb-0');
                    $('.dataTables_wrapper .dt-header-right').addClass('flex-grow-0 flex-shrink-0 w-full md:w-auto');
                    $('.dataTables_wrapper .dt-footer').addClass('flex flex-wrap justify-between items-center mt-4 pt-2 border-t border-gray-200');
                    $('.dataTables_wrapper .dt-footer-left').addClass('flex-grow-0 flex-shrink-0 mb-2 md:mb-0');
                    $('.dataTables_wrapper .dt-footer-right').addClass('flex-grow-0 flex-shrink-0');
                    
                    // Mejorar la apariencia del cuadro de búsqueda
                    $('.dataTables_filter input').addClass('ml-2 pl-8 pr-2 py-1 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent');
                    $('.dataTables_filter label').addClass('relative inline-block');
                    
                    // Añadir icono al cuadro de búsqueda
                    var searchIcon = '<div class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"><i class="fas fa-search"></i></div>';
                    $('.dataTables_filter label').addClass('relative').prepend(searchIcon);
                    
                    // Estilizar el selector de registros por página
                    $('.dataTables_length select').addClass('ml-2 mr-2 pl-2 pr-8 py-1 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent');
                },
                drawCallback: function() {
                    // Efectos de hover en las filas
                    $('tbody tr').hover(
                        function() { $(this).addClass('bg-yellow-100'); },
                        function() { $(this).removeClass('bg-yellow-100'); }
                    );
                    
                    // Añadir clases a los controles de paginación
                    $('.dataTables_paginate .paginate_button').addClass('px-3 py-1 mx-1 rounded-md border border-gray-200 hover:bg-blue-500 hover:text-white transition-colors duration-200');
                    $('.dataTables_paginate .paginate_button.current').addClass('bg-blue-500 text-white border-blue-500');
                    $('.dataTables_paginate .paginate_button.disabled').addClass('opacity-50 cursor-not-allowed');
                }
            });
            
            // Establecer variable global
            window.tablaCompras = tabla;
            
            // Inicializar DateRangePicker
            $('#daterange').daterangepicker({
                autoUpdateInput: false,
                locale: {
                    format: 'DD/MM/YYYY',
                    cancelLabel: 'Limpiar',
                    applyLabel: 'Aplicar',
                    daysOfWeek: ['Do', 'Lu', 'Ma', 'Mi', 'Ju', 'Vi', 'Sa'],
                    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
                    firstDay: 1
                }
            });
            
            // Cuando se aplica un rango de fechas
            $('#daterange').on('apply.daterangepicker', function(ev, picker) {
                // Actualizar el texto del input
                $(this).val(picker.startDate.format('DD/MM/YYYY') + ' - ' + picker.endDate.format('DD/MM/YYYY'));
                
                // Guardar las fechas para el filtro
                window.startDate = picker.startDate.toDate();
                window.startDate.setHours(0,0,0,0);
                window.endDate = picker.endDate.toDate();
                window.endDate.setHours(23,59,59,999);
                
                // Aplicar el filtro
                tabla.draw();
                
                // Resetear los botones
                $('.filter-btn').removeClass('active');
            });
            
            // Cuando se limpia el rango de fechas desde el picker
            $('#daterange').on('cancel.daterangepicker', function(ev, picker) {
                $(this).val('');
                window.startDate = undefined;
                window.endDate = undefined;
                tabla.draw();
                $('.filter-btn').removeClass('active');
            });
            
            // Limpiar filtro con el botón X
            $('#clearDateFilter').on('click', function() {
                $('#daterange').val('');
                window.startDate = undefined;
                window.endDate = undefined;
                tabla.draw();
                $('.filter-btn').removeClass('active');
            });
            
            // Filtros predefinidos
            $('#filterToday').on('click', function() {
                $('.filter-btn').removeClass('active');
                $(this).addClass('active');
                
                const today = new Date();
                today.setHours(0,0,0,0);
                window.startDate = today;
                window.endDate = new Date();
                window.endDate.setHours(23,59,59,999);
                
                $('#daterange').val(moment(today).format('DD/MM/YYYY') + ' - ' + moment(today).format('DD/MM/YYYY'));
                tabla.draw();
            });
            
            $('#filterWeek').on('click', function() {
                $('.filter-btn').removeClass('active');
                $(this).addClass('active');
                
                const today = new Date();
                const dayOfWeek = today.getDay();
                const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // Ajuste para comenzar en lunes
                
                const startOfWeek = new Date(today.setDate(diff));
                startOfWeek.setHours(0,0,0,0);
                
                const endOfWeek = new Date();
                endOfWeek.setHours(23,59,59,999);
                
                window.startDate = startOfWeek;
                window.endDate = endOfWeek;
                
                $('#daterange').val(moment(startOfWeek).format('DD/MM/YYYY') + ' - ' + moment(endOfWeek).format('DD/MM/YYYY'));
                tabla.draw();
            });
            
            $('#filterMonth').on('click', function() {
                $('.filter-btn').removeClass('active');
                $(this).addClass('active');
                
                const date = new Date();
                const startOfMonth = new Date(date.getFullYear(), date.getMonth(), 1);
                startOfMonth.setHours(0,0,0,0);
                
                const endOfMonth = new Date();
                endOfMonth.setHours(23,59,59,999);
                
                window.startDate = startOfMonth;
                window.endDate = endOfMonth;
                
                $('#daterange').val(moment(startOfMonth).format('DD/MM/YYYY') + ' - ' + moment(endOfMonth).format('DD/MM/YYYY'));
                tabla.draw();
            });
            
            $('#filterYear').on('click', function() {
                $('.filter-btn').removeClass('active');
                $(this).addClass('active');
                
                const date = new Date();
                const startOfYear = new Date(date.getFullYear(), 0, 1);
                startOfYear.setHours(0,0,0,0);
                
                const endOfYear = new Date();
                endOfYear.setHours(23,59,59,999);
                
                window.startDate = startOfYear;
                window.endDate = endOfYear;
                
                $('#daterange').val(moment(startOfYear).format('DD/MM/YYYY') + ' - ' + moment(endOfYear).format('DD/MM/YYYY'));
                tabla.draw();
            });
        });

        // Gráfico de compras mensuales
        document.addEventListener('DOMContentLoaded', function() {
            const ctx = document.getElementById('comprasMensualesChart').getContext('2d');
            const meses = {{ meses|safe }};
            const datosCompras = {{ datos_meses|safe }};
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: meses,
                    datasets: [{
                        label: 'Total de Compras ($)',
                        data: datosCompras,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2,
                        tension: 0.4,
                        pointBackgroundColor: 'rgba(75, 192, 192, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Total: $' + context.raw.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        });
    </script>
  <script>
    // Función para actualizar las tarjetas de compras por tipo de pago y acumulados según el filtro aplicado
    function actualizarTarjetasTipoPago() {
        // Verificar si la tabla está definida
        if (!window.tablaCompras) {
            console.error('La tabla no está definida');
            return;
        }

        // Mostrar indicador de filtrado
        const hayFiltro = window.startDate !== undefined || $('#tablaCompras_filter input').val() !== '';
        $('#filtro-indicador').toggleClass('hidden', !hayFiltro);
        $('#acumulados-filtro-indicador').toggleClass('hidden', !hayFiltro);

        // Inicializar contadores por tipo de pago
        const tiposPago = {
            'Efectivo': { total: 0, cantidad: 0, color: 'green' },
            'Deposito': { total: 0, cantidad: 0, color: 'blue' },
            'Transferencia': { total: 0, cantidad: 0, color: 'purple' },
            'Cheque': { total: 0, cantidad: 0, color: 'yellow' },
            'No definido': { total: 0, cantidad: 0, color: 'gray' }
        };
        
        // Variables para acumulados
        let totalGeneral = 0;
        let totalHoy = 0;
        let totalMes = 0;
        
        // Fecha actual para comparaciones
        const today = new Date();
        today.setHours(0,0,0,0);
        const currentMonth = today.getMonth();
        const currentYear = today.getFullYear();

        // Recorrer todas las filas visibles después de aplicar el filtro
        tablaCompras.rows({ search: 'applied' }).every(function (rowIdx) {
            const data = this.data();

            // Obtener el tipo de pago (columna 7) y el monto total (columna 6)
            let tipoPago = '';
            if (data[7].includes('Efectivo')) tipoPago = 'Efectivo';
            else if (data[7].includes('Deposito') || data[7].includes('Depósito')) tipoPago = 'Deposito';
            else if (data[7].includes('Transferencia')) tipoPago = 'Transferencia';
            else if (data[7].includes('Cheque')) tipoPago = 'Cheque';
            else tipoPago = 'No definido';

            // Extraer el monto (eliminar $ y comas)
            // Esto es crítico: debemos eliminar correctamente el símbolo $ y las comas
            const montoStr = data[6].replace(/[$,]/g, '');
            console.log('Monto extraído:', data[6], '→', montoStr); // Debug
            const monto = parseFloat(montoStr);

            if (!isNaN(monto)) {
                tiposPago[tipoPago].total += monto;
                tiposPago[tipoPago].cantidad++;
                totalGeneral += monto;
                
                // Comprobar si es de hoy o de este mes para acumulados
                const fechaStr = data[1]; // La fecha está en la segunda columna (índice 1)
                if (fechaStr) {
                    try {
                        // Formato dd/mm/yyyy
                        const parts = fechaStr.split('/');
                        if (parts.length === 3) {
                            const day = parseInt(parts[0], 10);
                            const month = parseInt(parts[1], 10) - 1; // Los meses en JS van de 0-11
                            const year = parseInt(parts[2], 10);
                            
                            const rowDate = new Date(year, month, day);
                            
                            // Si es hoy
                            if (rowDate.getDate() === today.getDate() && 
                                rowDate.getMonth() === today.getMonth() && 
                                rowDate.getFullYear() === today.getFullYear()) {
                                totalHoy += monto;
                            }
                            
                            // Si es de este mes
                            if (rowDate.getMonth() === currentMonth && 
                                rowDate.getFullYear() === currentYear) {
                                totalMes += monto;
                            }
                        }
                    } catch (e) {
                        console.error('Error al parsear la fecha:', fechaStr, e);
                    }
                }
            }
        });

        // Función para formatear números como moneda sin afectar el valor
        function formatearMoneda(valor) {
            // Asegurar que sea un número y redondearlo a 2 decimales
            valor = parseFloat(valor.toFixed(2));
            
            // Separar la parte entera y decimal
            let partes = valor.toString().split('.');
            let parteEntera = partes[0];
            let parteDecimal = partes.length > 1 ? '.' + partes[1] : '.00';
            
            // Añadir comas como separadores de miles
            parteEntera = parteEntera.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            
            return '$' + parteEntera + parteDecimal;
        }

        console.log('Totales calculados:'); // Debug
        console.log('Total General:', totalGeneral); 
        console.log('Total Hoy:', totalHoy);
        console.log('Total Mes:', totalMes);

        // Actualizar tarjetas de acumulados con números formateados correctamente
        $('#total-compras').data('total', totalGeneral);
        $('#acumulado-diario').data('total', totalHoy);
        $('#acumulado-mensual').data('total', totalMes);
        
        // Actualizar HTML con el formato correcto
        if (hayFiltro) {
            $('#total-compras').html(formatearMoneda(totalGeneral));
            $('#acumulado-diario').html(formatearMoneda(totalHoy));
            $('#acumulado-mensual').html(formatearMoneda(totalMes));
        }
        
        if (hayFiltro) {
            $('#acumulado-filtrado-label').html(`${tablaCompras.rows({ search: 'applied' }).count()} registros filtrados`);
        } else {
            $('#acumulado-filtrado-label').html('Total sin filtros');
        }

        // Vaciar y reconstruir el contenedor de tipos de pago
        const container = $('#compras-tipo-pago-container');
        container.empty();

        // Comprobar si hay datos
        let hayDatos = false;
        for (const tipo in tiposPago) {
            if (tiposPago[tipo].cantidad > 0) {
                hayDatos = true;
                break;
            }
        }

        // Si no hay datos, mostrar mensaje
        if (!hayDatos) {
            container.html(`
                <div class="col-span-4 text-center py-4 text-gray-500">
                    No hay datos disponibles para el filtro actual
                </div>
            `);
            return;
        }

        // Crear tarjetas para cada tipo de pago
        for (const tipo in tiposPago) {
            if (tiposPago[tipo].cantidad > 0) {
                const tarjeta = $(`
                    <div class="bg-gray-50 p-3 rounded-md border border-gray-200" data-tipo-pago="${tipo}">
                        <h3 class="font-semibold text-lg">${tipo}</h3>
                        <p class="text-xl font-bold text-${tiposPago[tipo].color}-600">${formatearMoneda(tiposPago[tipo].total)}</p>
                        <p class="text-sm text-gray-500">${tiposPago[tipo].cantidad} transacciones</p>
                    </div>
                `);
                container.append(tarjeta);
            }
        }

        // Si hay un filtro aplicado, actualizar la tarjeta de total
        if (hayFiltro) {
            // Usar nuestra función de formateo personalizada
            $('#total-compras-label').html('Total Filtrado');
        } else {
            // Restaurar el valor original
            $('#total-compras').html(`${{ total_compras|floatformat:2|intcomma }}`);
            $('#total-compras-label').html('Acumulado histórico');
        }
        
        console.log('Tarjetas actualizadas:', tiposPago);
    }
    
    $(document).ready(function() {
        // Esperar a que la tabla esté completamente inicializada
        setTimeout(function() {
            // Registrar evento después de que la tabla esté lista
            tablaCompras.on('search.dt draw.dt page.dt', function() {
                console.log('Filtro aplicado a la tabla');
                actualizarTarjetasTipoPago();
            });
            
            // Registrar eventos para los filtros específicos
            $('#daterange').on('apply.daterangepicker', function() {
                console.log('Filtro de fecha aplicado');
                setTimeout(actualizarTarjetasTipoPago, 100);
            });
            
            $('#daterange').on('cancel.daterangepicker', function() {
                console.log('Filtro de fecha cancelado');
                setTimeout(actualizarTarjetasTipoPago, 100);
            });
            
            $('#clearDateFilter').on('click', function() {
                console.log('Filtro de fecha limpiado');
                setTimeout(actualizarTarjetasTipoPago, 100);
            });
            
            // También para los botones de filtro rápido
            $('#filterToday, #filterWeek, #filterMonth, #filterYear').on('click', function() {
                console.log('Filtro rápido aplicado:', $(this).attr('id'));
                setTimeout(actualizarTarjetasTipoPago, 200);
            });
            
            // Ejecutar la primera vez para inicializar
            actualizarTarjetasTipoPago();
        }, 1000);
    });
</script>
<script>
    // Trigger a refresh of the formatted values
    $('#total-compras, #acumulado-diario, #acumulado-mensual').each(function() {
        const total = $(this).data('total');
        $(this).html(`$${parseFloat(total).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`);
    });
</script>
{% endblock %}

{% extends '_base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Análisis de Compras - Agrícola de la Costa{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">

{% endblock %}

{% block content %}
<div class="py-6 px-2">
  <h1 class="text-3xl font-bold flex items-center mb-8 text-gray-800 border-b pb-2">
    <i class="fas fa-chart-line mr-3 text-blue-600"></i>
    <span class="bg-clip-text text-gray-800">Análisis de compras </span>
  </h1>

  <!-- Filtros -->
  <div class="bg-gradient-to-r from-blue-50 to-emerald-50 shadow-md rounded-lg p-5 border border-gray-200 mb-10">
    <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
      <i class="fas fa-filter mr-2 text-blue-500"></i> Filtros de Búsqueda
    </h2>
    <form method="get" action="{% url 'compras_productores' %}" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      <!-- Cuenta -->
      <div class="transform hover:scale-105 transition-transform duration-300 group">
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 mb-2">
          <i class="fas fa-university mr-1"></i> Cuenta
        </span>
        <label for="cuenta_id" class="block mb-1 text-sm font-medium text-gray-800 group-hover:text-blue-600 transition-colors duration-200">
          Seleccione una cuenta bancaria
        </label>
        <div class="relative rounded-md shadow-sm">
          <select id="cuenta_id" name="cuenta_id" 
            class="block w-full p-2 text-sm text-gray-900 border border-gray-300 rounded-lg bg-white shadow-sm 
                  focus:ring-2 focus:ring-blue-300 focus:border-blue-400
                  hover:border-blue-300 transition-colors duration-200
                  pr-10 appearance-none">
            <option value="">Todas las cuentas</option>
            {% for cuenta in cuentas %}
            <option value="{{ cuenta.id }}" {% if selected_cuenta_id == cuenta.id|stringformat:"s" %}selected{% endif %}>
              {{ cuenta.numero_cuenta }} - {{ cuenta.id_banco.nombre }}
            </option>
            {% endfor %}
          </select>
          <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
            <i class="fas fa-chevron-down text-xs"></i>
          </div>
        </div>
      </div>

      <!-- Productor -->
      <div class="transform hover:scale-105 transition-transform duration-300 group">
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 mb-2">
          <i class="fas fa-user-tie mr-1"></i> Productor
        </span>
        <label for="productor_id" class="block mb-1 text-sm font-medium text-gray-800 group-hover:text-green-600 transition-colors duration-200">
          Seleccione un productor
        </label>
        <div class="relative rounded-md shadow-sm">
          <select id="productor_id" name="productor_id" 
            class="block w-full p-2 text-sm text-gray-900 border border-gray-300 rounded-lg bg-white shadow-sm 
                  focus:ring-2 focus:ring-green-300 focus:border-green-400
                  hover:border-green-300 transition-colors duration-200
                  pr-10 appearance-none">
            <option value="">Todos los productores</option>
            {% for productor in productores %}
            <option value="{{ productor.id }}" {% if selected_productor_id == productor.id|stringformat:"s" %}selected{% endif %}>
              {{ productor.nombre_completo }}
            </option>
            {% endfor %}
          </select>
          <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
            <i class="fas fa-chevron-down text-xs"></i>
          </div>
        </div>
      </div>

      <!-- Producto -->
      <div class="transform hover:scale-105 transition-transform duration-300 group">
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 mb-2">
          <i class="fas fa-box mr-1"></i> Producto
        </span>
        <label for="producto_id" class="block mb-1 text-sm font-medium text-gray-800 group-hover:text-yellow-600 transition-colors duration-200">
          Seleccione un producto
        </label>
        <div class="relative rounded-md shadow-sm">
          <select id="producto_id" name="producto_id" 
            class="block w-full p-2 text-sm text-gray-900 border border-gray-300 rounded-lg bg-white shadow-sm 
                  focus:ring-2 focus:ring-yellow-300 focus:border-yellow-400
                  hover:border-yellow-300 transition-colors duration-200
                  pr-10 appearance-none">
            <option value="">Todos los productos</option>
            {% for producto in productos %}
            <option value="{{ producto.id }}" {% if selected_producto_id == producto.id|stringformat:"s" %}selected{% endif %}>
              {{ producto.nombre }} - {{ producto.variedad }}
            </option>
            {% endfor %}
          </select>
          <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
            <i class="fas fa-chevron-down text-xs"></i>
          </div>
        </div>
      </div>

      <!-- Tipo de Pago -->
      <div class="transform hover:scale-105 transition-transform duration-300 group">
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 mb-2">
          <i class="fas fa-credit-card mr-1"></i> Pago
        </span>
        <label for="tipo_pago" class="block mb-1 text-sm font-medium text-gray-800 group-hover:text-purple-600 transition-colors duration-200">
          Tipo de pago utilizado
        </label>
        <div class="relative rounded-md shadow-sm">
          <select id="tipo_pago" name="tipo_pago" 
            class="block w-full p-2 text-sm text-gray-900 border border-gray-300 rounded-lg bg-white shadow-sm 
                  focus:ring-2 focus:ring-purple-300 focus:border-purple-400
                  hover:border-purple-300 transition-colors duration-200
                  pr-10 appearance-none">
            <option value="">Todos los tipos</option>
            {% for tipo in tipos_pago %}
            <option value="{{ tipo }}" {% if selected_tipo_pago == tipo %}selected{% endif %}>
              {{ tipo }}
            </option>
            {% endfor %}
          </select>
          <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
            <i class="fas fa-chevron-down text-xs"></i>
          </div>
        </div>
      </div>

      <!-- Año -->
      <div class="transform hover:scale-105 transition-transform duration-300 group">
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800 mb-2">
          <i class="fas fa-calendar-year mr-1"></i> Año
        </span>
        <label for="year" class="block mb-1 text-sm font-medium text-gray-800 group-hover:text-indigo-600 transition-colors duration-200">
          Seleccione el año
        </label>
        <div class="relative rounded-md shadow-sm">
          <select id="year" name="year" 
            class="block w-full p-2 text-sm text-gray-900 border border-gray-300 rounded-lg bg-white shadow-sm 
                  focus:ring-2 focus:ring-indigo-300 focus:border-indigo-400
                  hover:border-indigo-300 transition-colors duration-200
                  pr-10 appearance-none">
            {% for year_obj in available_years %}
            <option value="{{ year_obj.year }}" {% if selected_year|stringformat:"s" == year_obj.year|stringformat:"s" %}selected{% endif %}>
              {{ year_obj.year }}
            </option>
            {% endfor %}
          </select>
          <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
            <i class="fas fa-chevron-down text-xs"></i>
          </div>
        </div>
      </div>

      <!-- Mes -->
      <div class="transform hover:scale-105 transition-transform duration-300 group">
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-pink-100 text-pink-800 mb-2">
          <i class="fas fa-calendar-alt mr-1"></i> Mes
        </span>
        <label for="month" class="block mb-1 text-sm font-medium text-gray-800 group-hover:text-pink-600 transition-colors duration-200">
          Seleccione el mes
        </label>
        <div class="relative rounded-md shadow-sm">
          <select id="month" name="month" 
            class="block w-full p-2 text-sm text-gray-900 border border-gray-300 rounded-lg bg-white shadow-sm 
                  focus:ring-2 focus:ring-pink-300 focus:border-pink-400
                  hover:border-pink-300 transition-colors duration-200
                  pr-10 appearance-none">
            <option value="">Todos los meses</option>
            {% for month_name in months %}
            <option value="{{ forloop.counter }}" {% if selected_month|stringformat:"s" == forloop.counter|stringformat:"s" %}selected{% endif %}>
              {{ month_name }}
            </option>
            {% endfor %}
          </select>
          <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
            <i class="fas fa-chevron-down text-xs"></i>
          </div>
        </div>
      </div>

      <!-- Periodo -->
      <div class="transform hover:scale-105 transition-transform duration-300 group">
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 mb-2">
          <i class="fas fa-clock mr-1"></i> Periodo
        </span>
        <label for="periodo" class="block mb-1 text-sm font-medium text-gray-800 group-hover:text-red-600 transition-colors duration-200">
          Agrupación de datos
        </label>
        <div class="relative rounded-md shadow-sm">
          <select id="periodo" name="periodo" 
            class="block w-full p-2 text-sm text-gray-900 border border-gray-300 rounded-lg bg-white shadow-sm 
                  focus:ring-2 focus:ring-red-300 focus:border-red-400
                  hover:border-red-300 transition-colors duration-200
                  pr-10 appearance-none periodo-select">
            <option value="diario" {% if selected_periodo == "diario" %}selected{% endif %}>Diario</option>
            <option value="semanal" {% if selected_periodo == "semanal" %}selected{% endif %}>Semanal</option>
            <option value="mensual" {% if selected_periodo == "mensual" %}selected{% endif %}>Mensual</option>
          </select>
          <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
            <i class="fas fa-chevron-down text-xs"></i>
          </div>
        </div>
      </div>

      <!-- Campos condicionales según el periodo -->
      <div id="filtro-diario" class="{% if selected_periodo != 'diario' %}hidden{% endif %} transform hover:scale-105 transition-transform duration-300 group">
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-cyan-100 text-cyan-800 mb-2">
          <i class="fas fa-calendar-day mr-1"></i> Fecha específica
        </span>
        <label for="dia" class="block mb-1 text-sm font-medium text-gray-800 group-hover:text-cyan-600 transition-colors duration-200">
          Fecha exacta para buscar
        </label>
        <div class="relative rounded-md shadow-sm">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">
            <i class="fas fa-calendar"></i>
          </div>
          <input type="date" id="dia" name="dia" value="{{ selected_dia }}" 
            class="block w-full p-2 pl-10 text-sm text-gray-900 border border-gray-300 rounded-lg bg-white shadow-sm 
                  focus:ring-2 focus:ring-cyan-300 focus:border-cyan-400
                  hover:border-cyan-300 transition-colors duration-200">
        </div>
      </div>

      <div id="filtro-rango" class="{% if selected_periodo != 'diario' %}hidden{% endif %} grid grid-cols-1 md:grid-cols-2 gap-2">
        <div class="transform hover:scale-105 transition-transform duration-300 group">
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800 mb-2">
            <i class="fas fa-calendar-minus mr-1"></i> Desde
          </span>
          <label for="fecha_inicio" class="block mb-1 text-sm font-medium text-gray-800 group-hover:text-emerald-600 transition-colors duration-200">
            Fecha de inicio
          </label>
          <div class="relative rounded-md shadow-sm">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">
              <i class="fas fa-calendar"></i>
            </div>
            <input type="date" id="fecha_inicio" name="fecha_inicio" value="{{ selected_fecha_inicio }}" 
              class="block w-full p-2 pl-10 text-sm text-gray-900 border border-gray-300 rounded-lg bg-white shadow-sm 
                    focus:ring-2 focus:ring-emerald-300 focus:border-emerald-400
                    hover:border-emerald-300 transition-colors duration-200">
          </div>
        </div>
        <div class="transform hover:scale-105 transition-transform duration-300 group">
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-teal-100 text-teal-800 mb-2">
            <i class="fas fa-calendar-plus mr-1"></i> Hasta
          </span>
          <label for="fecha_fin" class="block mb-1 text-sm font-medium text-gray-800 group-hover:text-teal-600 transition-colors duration-200">
            Fecha de fin
          </label>
          <div class="relative rounded-md shadow-sm">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">
              <i class="fas fa-calendar"></i>
            </div>
            <input type="date" id="fecha_fin" name="fecha_fin" value="{{ selected_fecha_fin }}" 
              class="block w-full p-2 pl-10 text-sm text-gray-900 border border-gray-300 rounded-lg bg-white shadow-sm 
                    focus:ring-2 focus:ring-teal-300 focus:border-teal-400
                    hover:border-teal-300 transition-colors duration-200">
          </div>
        </div>
      </div>

      <!-- Botones -->
      <div class="col-span-1 md:col-span-2 lg:col-span-4 flex justify-center mt-6 space-x-4">
        <button type="submit" 
          class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2.5 px-5 rounded shadow-md hover:shadow-lg 
                transition-all duration-300 flex items-center group">
          <i class="fas fa-filter mr-2 group-hover:animate-pulse"></i>Aplicar Filtros
        </button>
        <a href="{% url 'compras_productores' %}" 
          class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2.5 px-5 rounded shadow-md hover:shadow-lg 
                transition-all duration-300 flex items-center group">
          <i class="fas fa-undo mr-2 group-hover:animate-spin"></i>Restablecer
        </a>
      </div>
    </form>
  </div>

  <div class="border-b border-gray-200 my-8"></div>

  <!-- Resumen Principal -->
  <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
    <i class="fas fa-chart-pie mr-2 text-indigo-500"></i> Resumen de Compras
  </h2>

  <!-- Tarjetas de métricas -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
    <!-- Total de Compras -->
    <div class="metric-card border-blue-500">
      <div class="card-header flex items-center">
        <i class="fas fa-money-bill-wave text-blue-500 mr-2"></i> Total de Compras
      </div>
      <div class="card-value text-blue-600">${{ total_compras|floatformat:2|intcomma }}</div>
      <div class="card-label">Valor total de todas las compras</div>
    </div>

    <!-- Cantidad Total -->
    <div class="metric-card border-green-500">
      <div class="card-header flex items-center">
        <i class="fas fa-boxes text-green-500 mr-2"></i> Cantidad Total
      </div>
      <div class="card-value text-green-600">{{ cantidad_total|floatformat:2|intcomma }}</div>
      <div class="card-label">Unidades totales compradas</div>
    </div>

    <!-- Transacciones -->
    <div class="metric-card border-purple-500">
      <div class="card-header flex items-center">
        <i class="fas fa-exchange-alt text-purple-500 mr-2"></i> Transacciones
      </div>
      <div class="card-value text-purple-600">{{ numero_transacciones|intcomma }}</div>
      <div class="card-label">Número de operaciones</div>
    </div>

    <!-- Compra Promedio -->
    <div class="metric-card border-amber-500">
      <div class="card-header flex items-center">
        <i class="fas fa-chart-line text-amber-500 mr-2"></i> Compra Promedio
      </div>
      <div class="card-value text-amber-600">${{ promedio_compra|floatformat:2|intcomma }}</div>
      <div class="card-label">Valor promedio por compra</div>
    </div>
  </div>

  <div class="section-divider"></div>

  <!-- Sección de Análisis -->
  <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
    <i class="fas fa-analytics mr-2 text-blue-500"></i> Análisis Detallado
  </h2>

  <!-- Estadísticas adicionales -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
    <!-- Estadísticas de compra -->
    <div class="data-section">
      <h2 class="section-header">
        <i class="fas fa-calculator text-blue-500 mr-2"></i> Métricas de compra
      </h2>
      <div class="space-y-4">
        <div class="flex justify-between items-center p-2 rounded bg-blue-50 hover:bg-blue-100 transition-colors duration-200">
          <span class="text-gray-700 font-medium">Máxima:</span>
          <span class="font-semibold text-blue-700">${{ compra_maxima|floatformat:2|intcomma }}</span>
        </div>
        <div class="flex justify-between items-center p-2 rounded bg-green-50 hover:bg-green-100 transition-colors duration-200">
          <span class="text-gray-700 font-medium">Mínima:</span>
          <span class="font-semibold text-green-700">${{ compra_minima|floatformat:2|intcomma }}</span>
        </div>
        <div class="flex justify-between items-center p-2 rounded bg-yellow-50 hover:bg-yellow-100 transition-colors duration-200">
          <span class="text-gray-700 font-medium">Mediana:</span>
          <span class="font-semibold text-yellow-700">${{ compra_mediana|floatformat:2|intcomma }}</span>
        </div>
      </div>
    </div>

    <!-- Compras por tipo de pago -->
    <div class="data-section">
      <h2 class="section-header">
        <i class="fas fa-credit-card text-purple-500 mr-2"></i> Por Tipo de Pago
      </h2>
      <ul class="space-y-3">
        {% for tipo in compras_por_tipo_pago %}
        <li class="flex justify-between items-center p-2 rounded bg-purple-50 hover:bg-purple-100 transition-colors duration-200">
          <span class="text-gray-700 font-medium flex items-center">
            {% if tipo.tipo_pago == 'Efectivo' %}
              <i class="fas fa-money-bill-alt text-green-500 mr-2"></i>
            {% elif tipo.tipo_pago == 'Transferencia' %}
              <i class="fas fa-exchange-alt text-blue-500 mr-2"></i>
            {% elif tipo.tipo_pago == 'Cheque' %}
              <i class="fas fa-money-check text-amber-500 mr-2"></i>
            {% else %}
              <i class="fas fa-credit-card text-purple-500 mr-2"></i>
            {% endif %}
            {{ tipo.tipo_pago }}
          </span>
          <span class="font-semibold text-purple-700">${{ tipo.total|floatformat:2|intcomma }} <span class="text-sm text-gray-500">({{ tipo.cantidad }})</span></span>
        </li>
        {% empty %}
        <li class="text-gray-500 italic p-4 text-center bg-gray-50 rounded">No hay datos disponibles</li>
        {% endfor %}
      </ul>
    </div>

    <!-- Gráfico de compras mensuales -->
    <div class="data-section">
      <h2 class="section-header">
        <i class="fas fa-chart-bar text-emerald-500 mr-2"></i> Compras por Mes
      </h2>
      <div style="height: 300px;">
        <canvas id="comprasMensualesChart"></canvas>
      </div>
    </div>
  </div>

  <div class="section-divider"></div>

  <!-- Sección de Rankings -->
  <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
    <i class="fas fa-trophy mr-2 text-amber-500"></i> Rankings Principales
  </h2>

  <!-- Top productores y productos -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
    <!-- Top productores -->
    <div class="data-section">
      <h2 class="section-header">
        <i class="fas fa-users text-indigo-500 mr-2"></i> Top 5 Productores
      </h2>
      <div class="table-container">
        <table class="min-w-full bg-white">
          <thead>
            <tr>
              <th class="table-header text-left">Productor</th>
              <th class="table-header text-right">Total</th>
              <th class="table-header text-right">Compras</th>
            </tr>
          </thead>
          <tbody>
            {% for productor in top_productores %}
            <tr class="table-row-alt table-row-hover border-b">
              <td class="py-3 px-4">
                <div class="flex items-center">
                  <div class="bg-indigo-100 text-indigo-700 rounded-full h-8 w-8 flex items-center justify-center mr-3">
                    {{ productor.productor__nombre_completo|slice:":1" }}
                  </div>
                  <span>{{ productor.productor__nombre_completo }}</span>
                </div>
              </td>
              <td class="py-3 px-4 text-right font-medium text-blue-600">${{ productor.total_compras|floatformat:2|intcomma }}</td>
              <td class="py-3 px-4 text-right font-medium text-purple-600">{{ productor.cantidad_compras }}</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="3" class="py-6 text-center text-gray-500 italic">No hay datos disponibles</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Top productos -->
    <div class="data-section">
      <h2 class="section-header">
        <i class="fas fa-box text-amber-500 mr-2"></i> Top 5 Productos
      </h2>
      <div class="table-container">
        <table class="min-w-full bg-white">
          <thead>
            <tr>
              <th class="table-header text-left">Producto</th>
              <th class="table-header text-right">Total</th>
              <th class="table-header text-right">Cantidad</th>
              <th class="table-header text-right">Precio Promedio</th>
            </tr>
          </thead>
          <tbody>
            {% for producto in top_productos %}
            <tr class="table-row-alt table-row-hover border-b">
              <td class="py-3 px-4">
                <div class="flex items-center">
                  <div class="bg-amber-100 text-amber-700 rounded-full h-8 w-8 flex items-center justify-center mr-3">
                    {{ producto.producto__nombre|slice:":1" }}
                  </div>
                  <span>{{ producto.producto__nombre }} - {{ producto.producto__variedad }}</span>
                </div>
              </td>
              <td class="py-3 px-4 text-right font-medium text-blue-600">${{ producto.total|floatformat:2|intcomma }}</td>
              <td class="py-3 px-4 text-right font-medium text-green-600">{{ producto.cantidad|floatformat:2|intcomma }}</td>
              <td class="py-3 px-4 text-right font-medium text-amber-600">${{ producto.precio_promedio|floatformat:2|intcomma }}</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="4" class="py-6 text-center text-gray-500 italic">No hay datos disponibles</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="section-divider"></div>

  <!-- Sección de Datos Detallados -->
  <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
    <i class="fas fa-table mr-2 text-green-500"></i> Datos Completos
  </h2>

  <!-- Tabla principal de compras -->
  <div class="data-section">
    <h2 class="section-header">
      <i class="fas fa-list-alt text-blue-500 mr-2"></i> Detalle de Compras
    </h2>
    <div class="overflow-x-auto table-container">
      <table id="comprasTable" class="display responsive nowrap w-full">
        <thead>
          <tr>
            <th>Cuenta</th>
            <th>Productor</th>
            <th>Producto</th>
            <th>Tipo de Pago</th>
            <th>Fecha</th>
            <th>Cantidad</th>
            <th>Precio Unitario</th>
            <th>Total</th>
            <th>Acumulado</th>
          </tr>
        </thead>
        <tbody>
          {% for compra in compras_data %}
          <tr>
            <td>{{ compra.cuenta__numero_cuenta }} ({{ compra.cuenta__id_banco__nombre }})</td>
            <td>{{ compra.productor__nombre_completo }}</td>
            <td>{{ compra.producto__nombre }} - {{ compra.producto__variedad }}</td>
            <td>
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                {% if compra.tipo_pago == 'Efectivo' %}
                  bg-green-100 text-green-800
                {% elif compra.tipo_pago == 'Transferencia' %}
                  bg-blue-100 text-blue-800
                {% elif compra.tipo_pago == 'Cheque' %}
                  bg-amber-100 text-amber-800
                {% else %}
                  bg-purple-100 text-purple-800
                {% endif %}
              ">
                {{ compra.tipo_pago }}
              </span>
            </td>
            <td>
              {% if selected_periodo == 'diario' %}
                {{ compra.fecha_compra|date:"d/m/Y" }}
              {% elif selected_periodo == 'semanal' %}
                {{ compra.semana|date:"d/m/Y" }}
              {% elif selected_periodo == 'mensual' %}
                {{ compra.mes|date:"m/Y" }}
              {% endif %}
            </td>
            <td data-order="{{ compra.cantidad_total }}">{{ compra.cantidad_total|floatformat:2|intcomma }}</td>
            <td data-order="{{ compra.precio_promedio }}">${{ compra.precio_promedio|floatformat:2|intcomma }}</td>
            <td data-order="{{ compra.total_compras }}">
              <span class="font-medium text-blue-600">${{ compra.total_compras|floatformat:2|intcomma }}</span>
            </td>
            <td data-order="{{ compra.acumulado }}">
              <span class="font-medium text-green-600">${{ compra.acumulado|floatformat:2|intcomma }}</span>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="9" class="text-center py-6 text-gray-500 italic">No se encontraron compras con los filtros seleccionados</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
  $(document).ready(function() {
    // Inicializar DataTable con estilo mejorado
    $('#comprasTable').DataTable({
      responsive: true,
      pageLength: 25,
      language: {
        url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json'
      },
      dom: 'Bfrtip',
      buttons: [
        {
          extend: 'copy',
          className: 'bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-1 px-3 rounded shadow',
          text: '<i class="fas fa-copy mr-1"></i> Copiar'
        },
        {
          extend: 'csv',
          className: 'bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded shadow ml-2',
          text: '<i class="fas fa-file-csv mr-1"></i> CSV'
        },
        {
          extend: 'excel',
          className: 'bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded shadow ml-2',
          text: '<i class="fas fa-file-excel mr-1"></i> Excel'
        },
        {
          extend: 'pdf',
          className: 'bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded shadow ml-2',
          text: '<i class="fas fa-file-pdf mr-1"></i> PDF'
        },
        {
          extend: 'print',
          className: 'bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded shadow ml-2',
          text: '<i class="fas fa-print mr-1"></i> Imprimir'
        }
      ]
    });

    // Manejar cambios en el periodo seleccionado
    $('.periodo-select').change(function() {
      var periodo = $(this).val();
      if (periodo === 'diario') {
        $('#filtro-diario, #filtro-rango').removeClass('hidden');
      } else {
        $('#filtro-diario, #filtro-rango').addClass('hidden');
      }
    });

    // Gráfico de compras mensuales mejorado - AHORA HORIZONTAL
    var ctx = document.getElementById('comprasMensualesChart').getContext('2d');
    var mesesLabels = {{ meses_labels|safe }};
    var datosCompras = {{ datos_compras_mensuales|safe }};

    // Generar colores dinámicamente
    var backgroundColors = datosCompras.map((value, index) => {
      // Gradiente de azul a verde
      const hue = 200 + (index * 10) % 60;
      return `hsla(${hue}, 70%, 60%, 0.7)`;
    });

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: mesesLabels,
        datasets: [{
          label: 'Compras por Mes',
          data: datosCompras,
          backgroundColor: backgroundColors,
          borderColor: backgroundColors.map(color => color.replace('0.7', '1')),
          borderWidth: 1,
          borderRadius: 4,
          maxBarThickness: 30
        }]
      },
      options: {
        indexAxis: 'y',  // Esto hace que el gráfico sea horizontal
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleFont: {
              size: 14
            },
            bodyFont: {
              size: 13
            },
            callbacks: {
              label: function(context) {
                let label = context.dataset.label || '';
                if (label) {
                  label += ': ';
                }
                if (context.parsed.x !== null) {
                  label += new Intl.NumberFormat('es-MX', {
                    style: 'currency',
                    currency: 'MXN'
                  }).format(context.parsed.x);
                }
                return label;
              }
            }
          }
        },
        scales: {
          x: {
            beginAtZero: true,
            grid: {
              color: 'rgba(200, 200, 200, 0.2)'
            },
            ticks: {
              callback: function(value) {
                return '$' + value.toLocaleString();
              },
              font: {
                weight: 'bold'
              }
            }
          },
          y: {
            grid: {
              display: false
            },
            ticks: {
              font: {
                weight: 'bold'
              }
            }
          }
        },
        animation: {
          duration: 2000,
          easing: 'easeOutQuart'
        },
        hover: {
          mode: 'index',
          intersect: false
        }
      }
    });
  });
</script>
{% endblock %}
